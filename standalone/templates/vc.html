<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width="device-width", initial-scale=1.0">
    <title>Annuity Verification Certificate</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .floating-window {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1000px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        .window-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 200px;
            background-color: #f0f0f0;
            padding: 20px;
            overflow-y: auto;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar li {
            margin-bottom: 10px;
        }
        .sidebar a {
            text-decoration: none;
            color: #333;
        }
        .sidebar a:hover {
            text-decoration: underline;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 20px;
        }
        .nav-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #45a049;
        }
        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="tel"],
        .form-group input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .row {
            display: flex;
            gap: 10px;
        }
        .row input {
            flex: 1;
        }
        .identity-ver {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-wrap, .canvas-container {
            margin-bottom: 20px;
        }
        #video, #canvas {
            border: 1px solid #ddd;
            max-width: 100%;
        }
        .upload-container {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
        }
        .signature-box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
        }
        #signature-pad-1 {
            border: 1px solid #ddd;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .flash-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        .flash-message.success { background-color: #4CAF50; }
        .flash-message.error { background-color: #f44336; }
        .flash-message.info { background-color: #2196F3; }
    </style>
</head>
<body>
    <div class="overlay">
        <div class="floating-window">
            <div class="window-header">
                <h2>Annuity Verification Certificate</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="window-content">
                <div class="sidebar">
                    <h3>Progress</h3>
                    <ul>
                        <li><a href="#" class="step-link" data-step="1">Step 1: Personal Info</a></li>
                        <li><a href="#" class="step-link" data-step="2">Step 2: Identity Verification</a></li>
                        <li><a href="#" class="step-link" data-step="3">Step 3: Document Upload</a></li>
                        <li><a href="#" class="step-link" data-step="4">Step 4: Submission</a></li>
                    </ul>
                </div>
                <div class="main-content">
                    <form id="multiStepForm">
                        <div class="form-step active" id="step1">
                            <h3>Step 1: Personal Information</h3>
                            <p>Enter your personal details here.</p>
                            <div class="form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullName" name="fullName" required>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label for="idNumber">ID Number</label>
                                    <input type="number" id="idNumber" name="idNumber" required>
                                </div>
                                <div class="form-group">
                                    <label for="phoneNumber">Phone Number</label>
                                    <input type="tel" id="phoneNumber" name="phoneNumber" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="kraPin">KRA Pin</label>
                                <input type="text" id="kraPin" name="kraPin" required>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label for="address">Address</label>
                                    <input type="text" id="address" name="address" required>
                                </div>
                                <div class="form-group">
                                    <label for="code">Code</label>
                                    <input type="text" id="code" name="code" required>
                                </div>
                                <div class="form-group">
                                    <label for="town">Town</label>
                                    <input type="text" id="town" name="town" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="emailAddress">Email Address</label>
                                <input type="email" id="emailAddress" name="emailAddress" required>
                            </div>
                        </div>
                        <div class="form-step" id="step2">
                            <h3>Step 2: Identity Verification</h3>
                            <p>Please enable your camera to take a selfie. Look straight into the camera.</p>
                            <div class="identity-ver">
                                <div class="video-wrap">
                                    <video id="video" playsinline autoplay></video>
                                    <div class="controller">
                                        <button type="button" id="snap">Capture</button>
                                    </div>
                                </div>
                                <div class="canvas-container">
                                    <h4>Check Selfie</h4>
                                    <p>Make sure your selfie clearly shows your face</p>
                                    <canvas id="canvas" width="300" height="300"></canvas>
                                    <div class="canvas-btn">
                                        <button type="button" id="redo">Redo</button>
                                        <button type="button" id="confirm">Confirm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-step" id="step3">
                            <h3>Step 3: Document Upload</h3>
                            <p>Upload the following documents: ID front and back, KRA Pin Certificate</p>
                            <div class="upload-container">
                                <div class="upload-files">
                                    <label for="input-file" id="drop-area">
                                        <img src="/api/placeholder/100/100" alt="Upload icon">
                                        <p>Drag and drop your files here or click to browse</p>
                                        <input type="file" accept="image/*,.pdf" id="input-file" multiple>
                                    </label>
                                    <p id="fileSizeMessage" style="color: red;"></p>
                                </div>
                                <div class="uploaded-files">
                                    <p>Uploaded Files:</p>
                                    <div id="uploaded-files-list"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-step" id="step4">
                            <h3>Step 4: Submission</h3>
                            <p>Please sign and accept the data protection clause to submit successfully.</p>
                            <div class="signature-box">
                                <label for="signature-pad-1">Sign Here:</label>
                                <canvas id="signature-pad-1" width="250" height="150"></canvas>
                                <div class="buttons">
                                    <button type="button" id="cancel-1">Cancel</button>
                                    <button type="button" id="accept-1">Accept</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Do you want Personal Relief?</label>
                                <input type="radio" name="personalRelief" id="personal-relief-yes" value="yes" required>
                                <label for="personal-relief-yes">Yes</label>
                                <input type="radio" name="personalRelief" id="personal-relief-no" value="no" required>
                                <label for="personal-relief-no">No</label>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="dataProtection" required>
                                <label for="dataProtection">I agree that I have read and understood the <a href="#" id="dataProtectionLink">Data Protection Notice</a>.</label>
                            </div>
                        </div>
                        <div class="button-container">
                            <button type="button" id="prevBtn" class="nav-button" disabled>Previous</button>
                            <button type="button" id="nextBtn" class="nav-button">Next</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="dataProtectionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Data Protection Agreement</h2>
            <p>Please read and accept our data protection terms before proceeding.</p>
            <p><!-- Add more content here as needed --></p>
            <div class="modal-buttons">
                <button class="complete" id="completeButton">Accept</button>
                <button class="reject" id="rejectButton">Reject</button>
            </div>
        </div>
    </div>

    <div id="flashMessage" class="flash-message"></div>

</body>   

    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        // Global variables and constants
        const BLINK_THRESHOLD = 500000;
        const MOVEMENT_THRESHOLD = 500000;
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_FILE_TYPES = ['application/pdf', 'image/jpeg', 'image/jpg'];

        let currentStep = 1;
        const totalSteps = 4;
        let signaturePad;

        // DOM Elements
        const form = document.getElementById('multiStepForm');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapButton = document.getElementById('snap');
        const redoButton = document.getElementById('redo');
        const confirmButton = document.getElementById('confirm');
        const fileInput = document.getElementById('input-file');
        const fileList = document.getElementById('uploaded-files-list');
        const flashMessageElement = document.getElementById('flashMessage');

        // Utility functions
        const showFlashMessage = (message, type = 'info') => {
            flashMessageElement.textContent = message;
            flashMessageElement.className = `flash-message ${type}`;
            flashMessageElement.style.display = 'block';
            setTimeout(() => {
                flashMessageElement.style.display = 'none';
            }, 3000);
        };

        // Form Navigation Module
        const FormNavigation = {
            updateButtons() {
                prevBtn.disabled = (currentStep === 1);
                nextBtn.textContent = (currentStep === totalSteps) ? 'Submit' : 'Next';
            },

            showStep(step) {
                document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
                document.getElementById(`step${step}`).classList.add('active');
                currentStep = step;
                this.updateButtons();

                if (step === 2) {
                    WebcamModule.startWebcam();
                } else if (step === 4 && !signaturePad) {
                    SignatureModule.initSignaturePad();
                }
            }
        };

        // Validation Module
        const Validation = {
            rules: {
                fullName: (value) => value.trim().length > 0,
                idNumber: (value) => /^\d{8}$/.test(value),
                phoneNumber: (value) => /^\d{10}$/.test(value),
                kraPin: (value) => /^[A-Z]\d{9}[A-Z]$/.test(value),
                emailAddress: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
            },

            validateStep(step) {
                const stepElement = document.getElementById(`step${step}`);
                const inputs = stepElement.querySelectorAll('input[required]');
                let isValid = true;

                inputs.forEach(input => {
                    const rule = this.rules[input.id] || (() => true);
                    if (!rule(input.value)) {
                        isValid = false;
                        this.showError(input, `Invalid ${input.name}`);
                    } else {
                        this.clearError(input);
                    }
                });

                // Step-specific validations
                if (step === 2) {
                    isValid = isValid && WebcamModule.validateSelfie();
                } else if (step === 3) {
                    isValid = isValid && FileUploadModule.validateFileUploads();
                } else if (step === 4) {
                    isValid = isValid && SignatureModule.validateSignature();
                }

                if (!isValid) {
                    showFlashMessage('Please correct the errors before proceeding.', 'error');
                }

                return isValid;
            },

            showError(input, message) {
                let errorElement = input.nextElementSibling;
                if (!errorElement || !errorElement.classList.contains('error-message')) {
                    errorElement = document.createElement('div');
                    errorElement.classList.add('error-message');
                    input.parentNode.insertBefore(errorElement, input.nextSibling);
                }
                errorElement.textContent = message;
                input.classList.add('error');
            },

            clearError(input) {
                const errorElement = input.nextElementSibling;
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.remove();
                }
                input.classList.remove('error');
            }
        };

        // File Upload Module
        const FileUploadModule = {
            handleFileUpload(event) {
                const files = event.target.files;
                fileList.innerHTML = '';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (this.isValidFile(file)) {
                        const listItem = document.createElement('div');
                        listItem.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                        fileList.appendChild(listItem);
                    } else {
                        showFlashMessage(`File ${file.name} is not allowed. Please upload only PDF or JPG files under 5MB.`, 'error');
                    }
                }
            },

            isValidFile(file) {
                return ALLOWED_FILE_TYPES.includes(file.type) && file.size <= MAX_FILE_SIZE;
            },

            validateFileUploads() {
                if (fileList.children.length === 0) {
                    showFlashMessage('Please upload at least one document.', 'error');
                    return false;
                }
                return true;
            }
        };

        // Webcam Module
        const WebcamModule = {
            stream: null,
            livenessChecks: {
                blinkDetected: false,
                movementDetected: false,
            },
            lastFrame: null,
            blinkCheckInterval: null,
            movementCheckInterval: null,
            feedbackElement: null,
            overlayElement: null,
            layoutStyle: null,

            startWebcam() {
                this.createFeedbackElement();
                this.createOverlayElement();
                this.adjustLayout();

                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(streamObj => {
                        this.stream = streamObj;
                        video.srcObject = this.stream;
                        video.play();
                        this.startLivenessDetection();
                    })
                    .catch(error => {
                        console.error("Error accessing the camera", error);
                        showFlashMessage("Unable to access the camera. Please ensure you've granted permission and try again.", 'error');
                    });
            },

            stopWebcam() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                video.srcObject = null;
                this.stopLivenessDetection();
                this.removeFeedbackElement();
                this.removeOverlayElement();
                this.resetLayout();
            },

            adjustLayout() {
                if (!this.layoutStyle) {
                    this.layoutStyle = document.createElement('style');
                    this.layoutStyle.id = 'webcam-layout-style';
                    document.head.appendChild(this.layoutStyle);
                }
                this.layoutStyle.textContent = `
                    body, html {
                        height: 100%;
                        margin: 0;
                        overflow: hidden;
                    }
                    .overlay {
                        display: flex;
                        flex-direction: column;
                        height: 100vh;
                        overflow: hidden;
                    }
                    .identity-ver {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }
                    #video, #canvas {
                        max-width: 100%;
                        max-height: 70vh;
                        width: auto;
                        height: auto;
                    }
                `;
            },

            resetLayout() {
                if (this.layoutStyle) {
                    this.layoutStyle.remove();
                    this.layoutStyle = null;
                }
            },

            createFeedbackElement() {
                this.feedbackElement = document.createElement('div');
                this.feedbackElement.id = 'liveness-feedback';
                this.feedbackElement.style.position = 'absolute';
                this.feedbackElement.style.bottom = '10px';
                this.feedbackElement.style.left = '0';
                this.feedbackElement.style.width = '100%';
                this.feedbackElement.style.textAlign = 'center';
                this.feedbackElement.style.color = 'white';
                this.feedbackElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                this.feedbackElement.style.padding = '5px';
                this.feedbackElement.style.zIndex = '10';
                document.querySelector('.identity-ver').appendChild(this.feedbackElement);
            },

            createOverlayElement() {
                this.overlayElement = document.createElement('div');
                this.overlayElement.id = 'face-guide-overlay';
                this.overlayElement.style.position = 'absolute';
                this.overlayElement.style.top = '0';
                this.overlayElement.style.left = '0';
                this.overlayElement.style.width = '100%';
                this.overlayElement.style.height = '100%';
                this.overlayElement.style.pointerEvents = 'none';
                this.overlayElement.style.zIndex = '5';

                const borderElement = document.createElement('div');
                borderElement.style.position = 'absolute';
                borderElement.style.top = '2%';
                borderElement.style.left = '2%';
                borderElement.style.width = '96%';
                borderElement.style.height = '96%';
                borderElement.style.border = '3px solid #00ff00';
                borderElement.style.boxSizing = 'border-box';

                const faceOutline = document.createElement('div');
                faceOutline.style.position = 'absolute';
                faceOutline.style.top = '20%';
                faceOutline.style.left = '25%';
                faceOutline.style.width = '50%';
                faceOutline.style.height = '60%';
                faceOutline.style.border = '2px dashed #00ff00';
                faceOutline.style.borderRadius = '50%';

                this.overlayElement.appendChild(borderElement);
                this.overlayElement.appendChild(faceOutline);
                document.querySelector('.video-wrap').appendChild(this.overlayElement);
            },

            removeFeedbackElement() {
                if (this.feedbackElement) {
                    this.feedbackElement.remove();
                    this.feedbackElement = null;
                }
            },

            removeOverlayElement() {
                if (this.overlayElement) {
                    this.overlayElement.remove();
                    this.overlayElement = null;
                }
            },

            startLivenessDetection() {
                this.updateFeedback("Please position your face within the green outline, then blink and move slightly.");
                this.blinkCheckInterval = setInterval(() => this.checkForBlink(), 200);
                this.movementCheckInterval = setInterval(() => this.checkForMovement(), 500);
            },

            stopLivenessDetection() {
                clearInterval(this.blinkCheckInterval);
                clearInterval(this.movementCheckInterval);
                this.livenessChecks.blinkDetected = false;
                this.livenessChecks.movementDetected = false;
            },

            checkForBlink() {
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                const totalBrightness = frame.data.reduce((sum, value, index) => (index % 4 !== 3) ? sum + value : sum, 0);
                
                if (this.lastFrame) {
                    const brightnessDiff = Math.abs(totalBrightness - this.lastFrame);
                    if (brightnessDiff > BLINK_THRESHOLD) {
                        this.livenessChecks.blinkDetected = true;
                        this.updateFeedback("Blink detected!");
                    }
                }
                this.lastFrame = totalBrightness;
            },

            checkForMovement() {
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                
                if (this.lastFrame) {
                    let diff = 0;
                    for (let i = 0; i < frame.data.length; i += 4) {
                        diff += Math.abs(frame.data[i] - this.lastFrame.data[i]);
                    }
                    if (diff > MOVEMENT_THRESHOLD) {
                        this.livenessChecks.movementDetected = true;
                        this.updateFeedback("Movement detected!");
                    }
                }
                this.lastFrame = frame;
            },

            takeSnapshot() {
                if (this.livenessChecks.blinkDetected || this.livenessChecks.movementDetected) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                    this.toggleElements(true);
                    this.stopLivenessDetection();
                    this.updateFeedback("Photo captured successfully!");
                } else {
                    this.updateFeedback("Please ensure your face is within the outline, then blink and move slightly before taking the photo.");
                }
            },

            toggleElements(showCanvas) {
                document.querySelector('.canvas-container').style.display = showCanvas ? 'block' : 'none';
                snapButton.style.display = showCanvas ? 'none' : 'inline-block';
                redoButton.style.display = showCanvas ? 'inline-block' : 'none';
                confirmButton.style.display = showCanvas ? 'inline-block' : 'none';
                video.style.display = showCanvas ? 'none' : 'block';
                canvas.style.display = showCanvas ? 'block' : 'none';
            },

            updateFeedback(message) {
                if (this.feedbackElement) {
                    this.feedbackElement.textContent = message;
                }
            },

            redoPhoto() {
                this.toggleElements(false);
                this.startLivenessDetection();
            },

            confirmPhoto() {
                showFlashMessage('Photo confirmed!', 'success');
                this.stopWebcam();
            },

            validateSelfie() {
                if (canvas.style.display === 'none') {
                    this.updateFeedback('Please take and confirm a photo.');
                    return false;
                }
                if (!this.livenessChecks.blinkDetected || !this.livenessChecks.movementDetected) {
                    this.updateFeedback('Liveness check incomplete. Please retake the photo.');
                    return false;
                }
                return true;
            }
        };

        // Signature Module
        const SignatureModule = {
            initSignaturePad() {
                const canvas = document.getElementById('signature-pad-1');
                signaturePad = new SignaturePad(canvas);

                document.getElementById('cancel-1').addEventListener('click', () => {
                    signaturePad.clear();
                });

                document.getElementById('accept-1').addEventListener('click', () => {
                    if (signaturePad.isEmpty()) {
                        showFlashMessage('Please provide a signature first.', 'error');
                    } else {
                        showFlashMessage('Signature accepted.', 'success');
                        // Here you could save the signature data
                        // const signatureData = signaturePad.toDataURL();
                    }
                });
            },

            validateSignature() {
                if (!signaturePad || signaturePad.isEmpty()) {
                    showFlashMessage('Please provide a signature.', 'error');
                    return false;
                }
                return true;
            }
        };

        // CSRF Protection
        const CSRFProtection = {
            token: null,

            init() {
                this.token = this.generateToken();
                this.addTokenToForm();
            },

            generateToken() {
                return Math.random().toString(36).substr(2) + Math.random().toString(36).substr(2);
            },

            addTokenToForm() {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = this.token;
                form.appendChild(tokenInput);
            },

            validateToken(token) {
                return token === this.token;
            }
        };

        function submitForm() {
            if (Validation.validateStep(totalSteps)) {
                try {
                    const formData = new FormData(form);
                    formData.append('signature', signaturePad.toDataURL());

                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('documents', fileInput.files[i]);
                    }

                    // Here you would typically send the data to a server
                    // For this example, we'll just log it to the console
                    console.log('Form submitted with the following data:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }

                    showFlashMessage('Form submitted successfully!', 'success');
                    // form.reset();
                    // window.location.href = 'thank-you-page.html';
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showFlashMessage('An error occurred while submitting the form. Please try again.', 'error');
                }
            }
        }

        // Event listeners
        nextBtn.addEventListener('click', () => {
            if (currentStep < totalSteps) {
                if (Validation.validateStep(currentStep)) {
                    FormNavigation.showStep(currentStep + 1);
                }
            } else {
                submitForm();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                FormNavigation.showStep(currentStep - 1);
            }
        });

        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const step = parseInt(link.getAttribute('data-step'));
                if (step < currentStep || Validation.validateStep(currentStep)) {
                    FormNavigation.showStep(step);
                }
            });
        });

        document.querySelector('.close-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to close the form? All progress will be lost.')) {
                document.querySelector('.overlay').style.display = 'none';
                WebcamModule.stopWebcam();
            }
        });

        snapButton.addEventListener('click', () => WebcamModule.takeSnapshot());
        redoButton.addEventListener('click', () => WebcamModule.redoPhoto());
        confirmButton.addEventListener('click', () => WebcamModule.confirmPhoto());
        fileInput.addEventListener('change', (event) => FileUploadModule.handleFileUpload(event));

        // Initialize the form
        FormNavigation.updateButtons();
        CSRFProtection.init();
    </script>
</body>
</html>