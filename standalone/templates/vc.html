<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width="device-width", initial-scale=1.0">
    <title>Annuity Verification Certificate</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .floating-window {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1000px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        .window-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 200px;
            background-color: #f0f0f0;
            padding: 20px;
            overflow-y: auto;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar li {
            margin-bottom: 10px;
        }
        .sidebar a {
            text-decoration: none;
            color: #333;
        }
        .sidebar a:hover {
            text-decoration: underline;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 20px;
        }

        .skip-btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #6c757d;  /* gray color, similar to secondary buttons */
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .skip-btn:hover {
            background-color: #5a6268;
        }

        .skip-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .nav-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #45a049;
        }
        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="tel"],
        .form-group input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .row {
            display: flex;
            gap: 10px;
        }
        .row input {
            flex: 1;
        }
        .identity-ver {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-wrap, .canvas-container {
            margin-bottom: 20px;
        }
        #video, #canvas {
            border: 1px solid #ddd;
            max-width: 100%;
        }
        .upload-container {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
        }
        .signature-box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
        }
        #signature-pad-1 {
            border: 1px solid #ddd;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .flash-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        .flash-message.success { background-color: #4CAF50; }
        .flash-message.error { background-color: #f44336; }
        .flash-message.info { background-color: #2196F3; }
    </style>
</head>
<body>
    <div class="overlay">
        <div class="floating-window">
            <div class="window-header">
                <h2>Annuity Verification Certificate</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="window-content">
                <div class="sidebar">
                    <h3>Progress</h3>
                    <ul>
                        <li><a href="#" class="step-link" data-step="1">Step 1: Personal Info</a></li>
                        <li><a href="#" class="step-link" data-step="2">Step 2: Identity Verification</a></li>
                        <li><a href="#" class="step-link" data-step="3">Step 3: Document Upload</a></li>
                        <li><a href="#" class="step-link" data-step="4">Step 4: Submission</a></li>
                    </ul>
                </div>
                <div class="main-content">
                    <form id="multiStepForm">
                        <div class="form-step active" id="step1">
                            <h3>Step 1: Personal Information</h3>
                            <p>Enter your personal details here.</p>
                            <div class="form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullName" name="fullName" required>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label for="idNumber">ID Number</label>
                                    <input type="number" id="idNumber" name="idNumber" required>
                                </div>
                                <div class="form-group">
                                    <label for="phoneNumber">Phone Number</label>
                                    <input type="tel" id="phoneNumber" name="phoneNumber" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="kraPin">KRA Pin</label>
                                <input type="text" id="kraPin" name="kraPin" required>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label for="address">Address</label>
                                    <input type="text" id="address" name="address" required>
                                </div>
                                <div class="form-group">
                                    <label for="code">Code</label>
                                    <input type="text" id="code" name="code" required>
                                </div>
                                <div class="form-group">
                                    <label for="town">Town</label>
                                    <input type="text" id="town" name="town" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="emailAddress">Email Address</label>
                                <input type="email" id="emailAddress" name="emailAddress" required>
                            </div>
                            <button type="button" class="skip-btn" data-skip="2">Skip</button>
                        </div>
                        <div class="form-step" id="step2">
                            <h3>Step 2: Identity Verification</h3>
                            <p>Please enable your camera to take a selfie. Look straight into the camera.</p>
                            <div class="identity-ver">
                                <div class="video-wrap">
                                    <video id="video" playsinline autoplay></video>
                                    <div class="controller">
                                        <button type="button" id="snap">Capture</button>
                                    </div>
                                </div>
                                <div class="canvas-container">
                                    <h4>Check Selfie</h4>
                                    <p>Make sure your selfie clearly shows your face</p>
                                    <canvas id="canvas" width="300" height="300"></canvas>
                                    <div class="canvas-btn">
                                        <button type="button" id="redo">Redo</button>
                                        <button type="button" id="confirm">Confirm</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="skip-btn" data-skip="3">Skip</button>
                        </div>
                        <div class="form-step" id="step3">
                            <h3>Step 3: Document Upload</h3>
                            <p>Upload the following documents: ID front and back, KRA Pin Certificate</p>
                            <div class="upload-container">
                                <div class="upload-files">
                                    <label for="input-file" id="drop-area">
                                        <img src="/api/placeholder/100/100" alt="Upload icon">
                                        <p>Drag and drop your files here or click to browse</p>
                                        <input type="file" accept="image/*,.pdf" id="input-file" multiple>
                                    </label>
                                    <p id="fileSizeMessage" style="color: red;"></p>
                                </div>
                                <div class="uploaded-files">
                                    <p>Uploaded Files:</p>
                                    <div id="uploaded-files-list"></div>
                                </div>
                            </div>
                            <button type="button" class="skip-btn" data-skip="4">Skip</button>
                        </div>
                        <div class="form-step" id="step4">
                            <h3>Step 4: Submission</h3>
                            <p>Please sign and accept the data protection clause to submit successfully.</p>
                            <div class="signature-box">
                                <label for="signature-pad-1">Sign Here:</label>
                                <canvas id="signature-pad-1" width="250" height="150"></canvas>
                                <div class="buttons">
                                    <button type="button" id="cancel-1">Cancel</button>
                                    <button type="button" id="accept-1">Accept</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Do you want Personal Relief?</label>
                                <input type="radio" name="personalRelief" id="personal-relief-yes" value="yes" required>
                                <label for="personal-relief-yes">Yes</label>
                                <input type="radio" name="personalRelief" id="personal-relief-no" value="no" required>
                                <label for="personal-relief-no">No</label>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="dataProtection" required>
                                <label for="dataProtection">I agree that I have read and understood the <a href="#" id="dataProtectionLink">Data Protection Notice</a>.</label>
                            </div>
                        </div>
                        <div class="button-container">
                            <button type="button" id="prevBtn" class="nav-button" disabled>Previous</button>
                            <button type="button" id="nextBtn" class="nav-button">Next</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="dataProtectionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Data Protection Notice</h2>
            <div class="modal-body">                
                <!-- Data Protection Agreement Content -->
                <p><strong>Introduction</strong><br>Your privacy and data protection are important to us. Please read the terms below carefully to understand how we collect, use, and protect your information. By accepting these terms, you consent to our data handling practices as outlined here.</p>

                <p><strong>1. Data Collection and Use</strong><br>We collect personal data to provide you with better service and to fulfill our obligations. This may include personal identification, contact information, and any data directly related to the services you receive from us.</p>

                <p><strong>2. Purpose of Data Processing</strong><br>Your personal data is processed to:
                    <ul>
                        <li>Facilitate our services and improve user experience.</li>
                        <li>Comply with legal obligations.</li>
                        <li>Communicate important updates and provide relevant information.</li>
                    </ul>
                </p>

                <p><strong>3. Data Sharing and Third Parties</strong><br>We may share your data with trusted third parties under strict data protection policies, ensuring that your information remains secure and confidential. These third parties are bound by data protection obligations equivalent to ours.</p>

                <p><strong>4. Data Security</strong><br>We implement technical and organizational measures to protect your data against unauthorized access, loss, or destruction. Only authorized personnel have access to your data, and they are required to handle it confidentially.</p>

                <p><strong>5. Your Rights</strong><br>You have the right to:
                    <ul>
                        <li>Access your data at any time.</li>
                        <li>Request corrections if any information is inaccurate.</li>
                        <li>Request the deletion of your data under certain circumstances.</li>
                        <li>Withdraw consent for specific uses at any time.</li>
                    </ul>
                </p>

                <p><strong>6. Retention Period</strong><br>Your data will only be kept for as long as necessary to fulfill the purposes outlined or as required by law.</p>

                <p><strong>7. Acceptance</strong><br>By selecting “Accept,” you acknowledge that you have read, understood, and agreed to the terms of our data protection agreement.</p>
            </div>
            <div class="modal-footer">
                <button id="completeButton" class="btn btn-primary">Accept</button>
                <button id="rejectButton" class="btn btn-secondary">Reject</button>
            </div>
        </div>
    </div>


    <div id="flashMessage" class="flash-message"></div>

</body>   

    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        // Global variables and constants
        const BLINK_THRESHOLD = 5000000;  // Adjust based on testing
        const MOVEMENT_THRESHOLD = 1000000;  // Adjust based on testing
        const MAX_RETRIES = 3;
        const API_TIMEOUT = 10000;
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_FILE_TYPES = ['application/pdf', 'image/jpeg', 'image/jpg'];

        let currentStep = 1;
        const totalSteps = 4;
        let signaturePad;

        // DOM Elements
        const form = document.getElementById('multiStepForm');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapButton = document.getElementById('snap');
        const redoButton = document.getElementById('redo');
        const confirmButton = document.getElementById('confirm');
        const fileInput = document.getElementById('input-file');
        const fileList = document.getElementById('uploaded-files-list');
        const flashMessageElement = document.getElementById('flashMessage');

        // Utility functions
        const showFlashMessage = (message, type = 'info') => {
            flashMessageElement.textContent = message;
            flashMessageElement.className = `flash-message ${type}`;
            flashMessageElement.style.display = 'block';
            setTimeout(() => {
                flashMessageElement.style.display = 'none';
            }, 3000);
        };

        // Form Navigation Module
        const FormNavigation = {
            updateButtons() {
                prevBtn.disabled = (currentStep === 1);
                nextBtn.textContent = (currentStep === totalSteps) ? 'Submit' : 'Next';
            },

            showStep(step) {
                document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
                document.getElementById(`step${step}`).classList.add('active');
                currentStep = step;
                this.updateButtons();

                if (step === 2) {
                    WebcamModule.startWebcam();
                } else if (step === 4 && !signaturePad) {
                    SignatureModule.initSignaturePad();
                }
            },

            skipToStep(step) {
                if (step >= 1 && step <= totalSteps) {  // Ensure step is within valid range
                    this.showStep(step);
                } else {
                    console.warn(`Step ${step} is out of range. Please enter a step between 1 and ${totalSteps}.`);
                }
            }
        };

        // Validation Module
        const Validation = {
            rules: {
                fullName: (value) => value.trim().length > 0,
                idNumber: (value) => /^\d{8}$/.test(value),
                phoneNumber: (value) => /^\d{10}$/.test(value),
                kraPin: (value) => /^[A-Z]\d{9}[A-Z]$/.test(value),
                emailAddress: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
            },

            validateStep(step) {
                const stepElement = document.getElementById(`step${step}`);
                const inputs = stepElement.querySelectorAll('input[required]');
                let isValid = true;

                inputs.forEach(input => {
                    const rule = this.rules[input.id] || (() => true);
                    if (!rule(input.value)) {
                        isValid = false;
                        this.showError(input, `Invalid ${input.name}`);
                    } else {
                        this.clearError(input);
                    }
                });

                // Step-specific validations
                if (step === 2) {
                    isValid = isValid && WebcamModule.validateSelfie();
                } else if (step === 3) {
                    isValid = isValid && FileUploadModule.validateFileUploads();
                } else if (step === 4) {
                    isValid = isValid && SignatureModule.validateSignature();
                }

                if (!isValid) {
                    showFlashMessage('Please correct the errors before proceeding.', 'error');
                }

                return isValid;
            },

            showError(input, message) {
                let errorElement = input.nextElementSibling;
                if (!errorElement || !errorElement.classList.contains('error-message')) {
                    errorElement = document.createElement('div');
                    errorElement.classList.add('error-message');
                    input.parentNode.insertBefore(errorElement, input.nextSibling);
                }
                errorElement.textContent = message;
                input.classList.add('error');
            },

            clearError(input) {
                const errorElement = input.nextElementSibling;
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.remove();
                }
                input.classList.remove('error');
            }
        };

        // File Upload Module
        const FileUploadModule = {
            handleFileUpload(event) {
                const files = event.target.files;
                fileList.innerHTML = '';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (this.isValidFile(file)) {
                        const listItem = document.createElement('div');
                        listItem.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                        fileList.appendChild(listItem);
                    } else {
                        showFlashMessage(`File ${file.name} is not allowed. Please upload only PDF or JPG files under 5MB.`, 'error');
                    }
                }
            },

            isValidFile(file) {
                return ALLOWED_FILE_TYPES.includes(file.type) && file.size <= MAX_FILE_SIZE;
            },

            validateFileUploads() {
                if (fileList.children.length === 0) {
                    showFlashMessage('Please upload at least one document.', 'error');
                    return false;
                }
                return true;
            }
        };

        // Webcam Module
        const WebcamModule = {
            stream: null,
            livenessChecks: {
                blinkDetected: false,
                movementDetected: false,
            },
            lastBlinkFrame: null,
            lastMovementFrame: null,
            blinkCheckInterval: null,
            movementCheckInterval: null,
            feedbackElement: null,
            overlayElement: null,
            layoutStyle: null,
            isProcessing: false,
            onPhotoConfirmed: null, // Callback for when photo is confirmed

            // Initialize the module
            async init(options = {}) {
                try {
                    this.onPhotoConfirmed = options.onPhotoConfirmed || null;
                    await this.checkBrowserSupport();
                    this.createElements();
                    this.adjustLayout();
                    await this.startWebcam();
                    this.setupEventListeners();
                    return true;
                } catch (error) {
                    console.error("Initialization error:", error);
                    this.handleError(error);
                    return false;
                }
            },

            // Setup event listeners for buttons
            setupEventListeners() {
                const snapButton = document.getElementById('snapButton');
                const redoButton = document.getElementById('redoButton');
                const confirmButton = document.getElementById('confirmButton');

                if (snapButton) {
                    snapButton.addEventListener('click', () => this.takeSnapshot());
                }
                if (redoButton) {
                    redoButton.addEventListener('click', () => this.redoPhoto());
                }
                if (confirmButton) {
                    confirmButton.addEventListener('click', () => {
                        if (this.confirmPhoto() && this.onPhotoConfirmed) {
                            const canvas = document.getElementById('canvas');
                            canvas.toBlob(blob => {
                                this.onPhotoConfirmed(blob);
                            }, 'image/jpeg', 0.95);
                        }
                    });
                }
            },

            // Check browser support for required features
            async checkBrowserSupport() {
                if (!navigator.mediaDevices?.getUserMedia) {
                    throw new Error("Camera access is not supported in this browser");
                }
            },

            // Create UI elements
            createElements() {
                this.createFeedbackElement();
                this.createOverlayElement();
                this.createLoadingIndicator();
            },

            async startWebcam() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: "user",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }, 
                        audio: false 
                    });
                    
                    const video = document.getElementById('video');
                    video.srcObject = this.stream;
                    await video.play();
                    
                    // Set canvas dimensions to match video
                    const canvas = document.getElementById('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    this.startLivenessDetection();
                    this.updateFeedback("Please position your face within the green outline");
                } catch (error) {
                    console.error("Error accessing the camera", error);
                    this.handleError(new Error("Unable to access the camera. Please ensure you've granted permission."));
                }
            },

            stopWebcam() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                const video = document.getElementById('video');
                video.srcObject = null;
                this.stopLivenessDetection();
                this.cleanup();
            },

            cleanup() {
                this.removeFeedbackElement();
                this.removeOverlayElement();
                this.removeLoadingIndicator();
                this.resetLayout();
                this.resetState();
            },

            resetState() {
                this.livenessChecks = {
                    blinkDetected: false,
                    movementDetected: false,
                };
                this.lastBlinkFrame = null;
                this.lastMovementFrame = null;
                this.isProcessing = false;
            },

            createLoadingIndicator() {
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'verification-loading';
                loadingIndicator.className = 'loading-indicator hidden';
                loadingIndicator.innerHTML = `
                    <div class="spinner"></div>
                    <div class="loading-text">Verifying...</div>
                `;
                document.querySelector('.identity-ver').appendChild(loadingIndicator);
                
                // Add CSS for loading indicator
                const style = document.createElement('style');
                style.textContent = `
                    .loading-indicator {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 20px;
                        border-radius: 10px;
                        text-align: center;
                        z-index: 1000;
                    }
                    .loading-indicator.hidden {
                        display: none;
                    }
                    .spinner {
                        width: 40px;
                        height: 40px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 10px;
                    }
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            },

            setLoadingState(isLoading) {
                this.isProcessing = isLoading;
                const loadingIndicator = document.getElementById('verification-loading');
                const snapButton = document.getElementById('snapButton');
                const redoButton = document.getElementById('redoButton');
                
                if (isLoading) {
                    loadingIndicator.classList.remove('hidden');
                    snapButton.disabled = true;
                    redoButton.disabled = true;
                } else {
                    loadingIndicator.classList.add('hidden');
                    snapButton.disabled = false;
                    redoButton.disabled = false;
                }
            },

            adjustLayout() {
                if (!this.layoutStyle) {
                    this.layoutStyle = document.createElement('style');
                    this.layoutStyle.id = 'webcam-layout-style';
                    document.head.appendChild(this.layoutStyle);
                }
                this.layoutStyle.textContent = `
                    body, html {
                        height: 100%;
                        margin: 0;
                        overflow: hidden;
                    }
                    .overlay {
                        display: flex;
                        flex-direction: column;
                        height: 100vh;
                        overflow: hidden;
                    }
                    .identity-ver {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                        position: relative;
                    }
                    #video, #canvas {
                        max-width: 100%;
                        max-height: 70vh;
                        width: auto;
                        height: auto;
                    }
                    .video-wrap {
                        position: relative;
                        width: 100%;
                        max-width: 640px;
                        margin: 0 auto;
                    }
                    .button-container {
                        margin-top: 20px;
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                    }
                    .button {
                        padding: 10px 20px;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 16px;
                        transition: background-color 0.3s;
                    }
                    .button:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                `;
            },

            createFeedbackElement() {
                this.feedbackElement = document.createElement('div');
                this.feedbackElement.id = 'liveness-feedback';
                this.feedbackElement.style.position = 'absolute';
                this.feedbackElement.style.bottom = '10px';
                this.feedbackElement.style.left = '0';
                this.feedbackElement.style.width = '100%';
                this.feedbackElement.style.textAlign = 'center';
                this.feedbackElement.style.color = 'white';
                this.feedbackElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                this.feedbackElement.style.padding = '5px';
                this.feedbackElement.style.zIndex = '10';
                document.querySelector('.identity-ver').appendChild(this.feedbackElement);
            },

            createOverlayElement() {
                this.overlayElement = document.createElement('div');
                this.overlayElement.id = 'face-guide-overlay';
                this.overlayElement.style.position = 'absolute';
                this.overlayElement.style.top = '0';
                this.overlayElement.style.left = '0';
                this.overlayElement.style.width = '100%';
                this.overlayElement.style.height = '100%';
                this.overlayElement.style.pointerEvents = 'none';
                this.overlayElement.style.zIndex = '5';

                const borderElement = document.createElement('div');
                borderElement.style.position = 'absolute';
                borderElement.style.top = '2%';
                borderElement.style.left = '2%';
                borderElement.style.width = '96%';
                borderElement.style.height = '96%';
                borderElement.style.border = '3px solid #00ff00';
                borderElement.style.boxSizing = 'border-box';

                const faceOutline = document.createElement('div');
                faceOutline.style.position = 'absolute';
                faceOutline.style.top = '20%';
                faceOutline.style.left = '25%';
                faceOutline.style.width = '50%';
                faceOutline.style.height = '60%';
                faceOutline.style.border = '2px dashed #00ff00';
                faceOutline.style.borderRadius = '50%';

                this.overlayElement.appendChild(borderElement);
                this.overlayElement.appendChild(faceOutline);
                document.querySelector('.video-wrap').appendChild(this.overlayElement);
            },

            removeFeedbackElement() {
                if (this.feedbackElement) {
                    this.feedbackElement.remove();
                    this.feedbackElement = null;
                }
            },

            removeOverlayElement() {
                if (this.overlayElement) {
                    this.overlayElement.remove();
                    this.overlayElement = null;
                }
            },

            
            toggleElements(showCanvas) {
                document.querySelector('.canvas-container').style.display = showCanvas ? 'block' : 'none';
                snapButton.style.display = showCanvas ? 'none' : 'inline-block';
                redoButton.style.display = showCanvas ? 'inline-block' : 'none';
                confirmButton.style.display = showCanvas ? 'inline-block' : 'none';
                video.style.display = showCanvas ? 'none' : 'block';
                canvas.style.display = showCanvas ? 'block' : 'none';
            },

            startLivenessDetection() {
                this.updateFeedback("Please blink and move slightly");
                this.blinkCheckInterval = setInterval(() => this.checkForBlink(), 200);
                this.movementCheckInterval = setInterval(() => this.checkForMovement(), 500);
            },

            stopLivenessDetection() {
                clearInterval(this.blinkCheckInterval);
                clearInterval(this.movementCheckInterval);
            },

            async checkForBlink() {
                if (this.isProcessing) return;

                const canvas = document.getElementById('canvas');
                const video = document.getElementById('video');
                const context = canvas.getContext('2d');
                
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                const totalBrightness = frame.data.reduce((sum, value, index) => 
                    (index % 4 !== 3) ? sum + value : sum, 0);
                
                if (this.lastBlinkFrame) {
                    const brightnessDiff = Math.abs(totalBrightness - this.lastBlinkFrame);
                    if (brightnessDiff > BLINK_THRESHOLD) {
                        this.livenessChecks.blinkDetected = true;
                        this.updateFeedback("Blink detected! ✓");
                        this.updateLivenessStatus();
                    }
                }
                this.lastBlinkFrame = totalBrightness;
            },

            async checkForMovement() {
                if (this.isProcessing) return;

                const canvas = document.getElementById('canvas');
                const video = document.getElementById('video');
                const context = canvas.getContext('2d');
                
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                
                if (this.lastMovementFrame) {
                    let diff = 0;
                    for (let i = 0; i < frame.data.length; i += 4) {
                        diff += Math.abs(frame.data[i] - this.lastMovementFrame.data[i]);
                    }
                    if (diff > MOVEMENT_THRESHOLD) {
                        this.livenessChecks.movementDetected = true;
                        this.updateFeedback("Movement detected! ✓");
                        this.updateLivenessStatus();
                    }
                }
                this.lastMovementFrame = frame;
            },

            updateLivenessStatus() {
                if (this.livenessChecks.blinkDetected && this.livenessChecks.movementDetected) {
                    this.updateFeedback("Liveness checks passed! You can take a photo now.");
                    document.getElementById('snapButton').disabled = false;
                }
            },

            async takeSnapshot() {
                if (!this.validateLivenessChecks()) {
                    return;
                }

                try {
                    this.setLoadingState(true);
                    this.updateFeedback("Processing your photo...");

                    const canvas = document.getElementById('canvas');
                    const video = document.getElementById('video');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

                    const blob = await this.canvasToBlob(canvas);
                    const verificationResult = await this.verifyFaceWithRetry(blob);

                    if (verificationResult.success) {
                        this.toggleElements(true);
                        this.stopLivenessDetection();
                        this.updateFeedback("Photo captured and verified successfully! ✓");
                    } else {
                        throw new Error(verificationResult.message || "Face verification failed");
                    }
                } catch (error) {
                    console.error('Photo capture error:', error);
                    this.updateFeedback(error.message || "An error occurred. Please try again.");
                    this.redoPhoto();
                } finally {
                    this.setLoadingState(false);
                }
            },

            validateLivenessChecks() {
                if (!this.livenessChecks.blinkDetected || !this.livenessChecks.movementDetected) {
                    this.updateFeedback("Please complete the liveness checks first");
                    return false;
                }
                return true;
            },

            async canvasToBlob(canvas) {
                return new Promise((resolve, reject) => {
                    try {
                        canvas.toBlob(resolve, 'image/jpeg', 0.95);
                    } catch (error) {
                        reject(new Error('Failed to convert image'));
                    }
                });
            },

            async verifyFaceWithRetry(imageBlob, attempts = 0) {
                try {
                    return await this.timeoutPromise(
                        this.verifyFaceWithBackend(imageBlob),
                        API_TIMEOUT
                    );
                } catch (error) {
                    if (attempts < MAX_RETRIES && this.shouldRetry(error)) {
                        await this.delay(Math.pow(2, attempts) * 1000); // Exponential backoff
                        return this.verifyFaceWithRetry(imageBlob, attempts + 1);
                    }
                    throw error;
                }
            },

            async verifyFaceWithBackend(imageBlob) {
                // For client-side testing, simulate verification
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            success: true,
                            message: "Face verification simulated successfully"
                        });
                    }, 1500); // Simulate network delay
                });
            },

            // Update feedback with timestamp for debugging
            updateFeedback(message) {
                if (this.feedbackElement) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.feedbackElement.textContent = `[${timestamp}] ${message}`;
                    console.log(`Feedback: ${message}`); // For debugging
                }
            },

            // Enhanced error handling
            handleError(error) {
                console.error('WebcamModule Error:', error);
                this.updateFeedback(error.message);
                this.setLoadingState(false);
                
                // Log additional debugging information
                if (error instanceof Error) {
                    console.debug({
                        name: error.name,
                        message: error.message,
                        stack: error.stack,
                        timestamp: new Date().toISOString()
                    });
                }
                
                if (error.message.includes('camera') || error.message.includes('permission')) {
                    this.stopWebcam();
                }
            },

            // Method to get current frame data for debugging
            async getDebugData() {
                const canvas = document.getElementById('canvas');
                const video = document.getElementById('video');
                const context = canvas.getContext('2d');
                
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                
                return {
                    frameData: {
                        width: frame.width,
                        height: frame.height,
                        dataSize: frame.data.length,
                    },
                    livenessChecks: { ...this.livenessChecks },
                    isProcessing: this.isProcessing,
                    streamActive: this.stream && this.stream.active,
                };
            }
        };

        // Signature Module
        const SignatureModule = {
            initSignaturePad() {
                const canvas = document.getElementById('signature-pad-1');
                signaturePad = new SignaturePad(canvas);

                document.getElementById('cancel-1').addEventListener('click', () => {
                    signaturePad.clear();
                });

                document.getElementById('accept-1').addEventListener('click', () => {
                    if (signaturePad.isEmpty()) {
                        showFlashMessage('Please provide a signature first.', 'error');
                    } else {
                        showFlashMessage('Signature accepted.', 'success');
                        // Here you could save the signature data
                        // const signatureData = signaturePad.toDataURL();
                    }
                });
            },

            validateSignature() {
                if (!signaturePad || signaturePad.isEmpty()) {
                    showFlashMessage('Please provide a signature.', 'error');
                    return false;
                }
                return true;
            }
        };

        // Data Protection Modal Module
        const DataProtectionModal = (function () {
            // Private variables
            let modal = null;
            let acceptButton = null;
            let rejectButton = null;
            let closeButton = null;
            
            // Configuration
            const config = {
                modalId: "dataProtectionModal",
                acceptButtonId: "completeButton",
                rejectButtonId: "rejectButton",
                closeButtonClass: "close",
                triggerLinkId: "dataProtectionLink"  // Add the link ID here
            };
            
            function init() {
                // Get DOM elements
                modal = document.getElementById(config.modalId);
                
                // Check if modal exists
                if (!modal) {
                    console.error("Data Protection Modal: Modal element not found");
                    return false;
                }
                
                // Get buttons
                acceptButton = document.getElementById(config.acceptButtonId);
                rejectButton = document.getElementById(config.rejectButtonId);
                closeButton = modal.querySelector(`.${config.closeButtonClass}`);
                
                // Validate required elements
                if (!acceptButton || !rejectButton) {
                    console.error("Data Protection Modal: Required buttons not found");
                    return false;
                }
                
                // Add event listeners
                addEventListeners();
                return true;
            }
            
            function addEventListeners() {
                // Add click event to open modal when clicking on the data protection link
                const triggerLink = document.getElementById(config.triggerLinkId);
                if (triggerLink) {
                    triggerLink.addEventListener("click", (event) => {
                        event.preventDefault();  // Prevent default link behavior
                        open();
                    });
                }
                
                // Close modal when clicking the close button
                if (closeButton) {
                    closeButton.addEventListener("click", close);
                }
                
                // Close modal when clicking outside
                window.addEventListener("click", (event) => {
                    if (event.target === modal) {
                        close();
                    }
                });
                
                // Handle accept button click
                acceptButton.addEventListener("click", () => {
                    handleAccept();
                });
                
                // Handle reject button click
                rejectButton.addEventListener("click", () => {
                    handleReject();
                });
            }
            
            function open() {
                if (!modal) {
                    console.error("Data Protection Modal: Cannot open - modal not initialized");
                    return;
                }
                modal.style.display = "block";
                modal.classList.add("active");
            }
            
            function close() {
                if (!modal) {
                    return;
                }
                modal.style.display = "none";
                modal.classList.remove("active");
            }
            
            function handleAccept() {
                localStorage.setItem("dataProtectionAccepted", "true");
                showFlashMessage("You have accepted the data protection terms.", "success");
                close();
                enableFormSubmission();
            }
            
            function handleReject() {
                localStorage.setItem("dataProtectionAccepted", "false");
                showFlashMessage("You have rejected the data protection terms. You cannot proceed further.", "warning");
                close();
                disableFormSubmission();
            }
            
            function enableFormSubmission() {
                const submitButton = document.querySelector("button[type='submit']");
                if (submitButton) {
                    submitButton.disabled = false;
                }
            }
            
            function disableFormSubmission() {
                const submitButton = document.querySelector("button[type='submit']");
                if (submitButton) {
                    submitButton.disabled = true;
                }
            }

            // Public API
            return {
                init,
                open,
                close,
                isAccepted: () => localStorage.getItem("dataProtectionAccepted") === "true"
            };
        })();

        // Initialize the modal functionality on DOM content load
        document.addEventListener('DOMContentLoaded', function() {
            DataProtectionModal.init();
        });


        // CSRF Protection
        const CSRFProtection = {
            token: null,

            init() {
                this.token = this.generateToken();
                this.addTokenToForm();
            },

            generateToken() {
                return Math.random().toString(36).substr(2) + Math.random().toString(36).substr(2);
            },

            addTokenToForm() {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = this.token;
                form.appendChild(tokenInput);
            },

            validateToken(token) {
                return token === this.token;
            }
        };

        function submitForm() {
            if (Validation.validateStep(totalSteps)) {
                try {
                    const formData = new FormData(form);
                    formData.append('signature', signaturePad.toDataURL());

                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('documents', fileInput.files[i]);
                    }

                    // Here you would typically send the data to a server
                    // For this example, we'll just log it to the console
                    console.log('Form submitted with the following data:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }

                    showFlashMessage('Form submitted successfully!', 'success');
                    // form.reset();
                    // window.location.href = 'thank-you-page.html';
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showFlashMessage('An error occurred while submitting the form. Please try again.', 'error');
                }
            }
        }

        // Event listeners
        nextBtn.addEventListener('click', () => {
            if (currentStep < totalSteps) {
                if (Validation.validateStep(currentStep)) {
                    FormNavigation.showStep(currentStep + 1);
                }
            } else {
                submitForm();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                FormNavigation.showStep(currentStep - 1);
            }
        });

        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const step = parseInt(link.getAttribute('data-step'));
                if (step < currentStep || Validation.validateStep(currentStep)) {
                    FormNavigation.showStep(step);
                }
            });
        });

        // Add click event listeners to all skip buttons
        document.querySelectorAll('.skip-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const skipToStep = parseInt(e.target.dataset.skip);
                FormNavigation.skipToStep(skipToStep);
            });
        });

        document.querySelector('.close-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to close the form? All progress will be lost.')) {
                document.querySelector('.overlay').style.display = 'none';
                WebcamModule.stopWebcam();
            }
        });

        snapButton.addEventListener('click', () => WebcamModule.takeSnapshot());
        redoButton.addEventListener('click', () => WebcamModule.redoPhoto());
        confirmButton.addEventListener('click', () => WebcamModule.confirmPhoto());
        fileInput.addEventListener('change', (event) => FileUploadModule.handleFileUpload(event));

        // Initialize the form
        FormNavigation.updateButtons();
        CSRFProtection.init();
    </script>
</body>
</html>