<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="" width="device-width", initial-scale="1.0">
    <title>Annuity Verification Certificate</title>
    
    <style>
        body, html {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            background-image: url('/vc_webform/webform_backend/static/img/blank_background.png');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            height: 100%;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .floating-window {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1000px;
            height: 83vh;
            display: flex;
            flex-direction: column;
        }
        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        .window-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 200px;
            background-color: #2c2e3a;
            color: #f4f4f4;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar h3 {
            font-size: 19px;
            font-family: 'Montserrat', Arial, serif;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            font-family: 'Montserrat', Arial, serif;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .sidebar li {
            position: relative;
            display: flex;
            align-items: center;
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .sidebar li.active {
            font-weight: bold;
            color: #f4f4f4;
        }

        .sidebar li.inactive {
            color: #777;
        }
        /* Adjust styling for each step description */
        .sidebar li a {
            text-decoration: none;
            color: inherit;
            font-size: 14px;
        }
        .sidebar li a:hover {
            text-decoration: underline;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 20px;
        }

        .skip-btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #6c757d;  /* gray color, similar to secondary buttons */
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .skip-btn:hover {
            background-color: #5a6268;
        }

        .skip-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .nav-button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', arial, serif;
        }
        .nav-button:hover {
            background-color: #3471d6;;
        }
        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #prevBtn {
            border: 2px solid black;
            border-radius: 8px;
            width: 70px;
            height: 35px;
            text-align: center;
        }
        #nextBtn {
            background-color: #3471d6;
            border-radius: 8px;
            border: none;
            width: 100px;
            height: 35px;
            color: white;
            font-family: 'Montserrat', arial, serif;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="tel"],
        .form-group input[type="email"] {
            width: 90%;
            padding: 8px;
            border: 3px solid #2c2e3a;
            border-radius: 7px;
            background-color: #f4f4f4;
            font-family: 'Montserrat', Arial, serif;
        }
        .row {
            display: flex;
            gap: 10px;
        }
        .row input {
            flex: 1;
        }
        
        /* Identity verification container */
        .identity-ver {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        /* Video wrap container */
        .video-wrap {
            position: relative;
            width: 100%;
            max-width: 320px;
            margin-bottom: 20px;
        }

        /* Video element styling */
        #video {
            width: 100%;
            height: auto;
            border-radius: 10px;
            border: 3px solid #ddd;
        }

        /* Canvas styling */
        #canvas {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            border: 3px solid #ddd;
            margin-bottom: 20px;
        }

        /* Button container and button styles */
        .canvas-btn {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        button#redo {
            background-color: #e74c3c;
        }

        button#redo:hover {
            background-color: #c0392b;
        }
        * Feedback message styling */
        #feedback {
            font-size: 14px;
            color: #2ecc71;
            margin-top: 15px;
        }

        /* Loading spinner and feedback styles */
        #feedback.error {
            color: #e74c3c;
        }

        /* Optional overlay and spinner for loading state */
        #verification-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            text-align: center;
            display: none;
        }

        #verification-loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #verification-loading.show {
            display: block;
        }

        /* File Upload styles */
        .upload-container {
            width: 90%;
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* File Upload Group */
        .file-upload-group {
            margin-bottom: 20px;
        }

        /* Label Style */
        .upload-label {
            display: block;
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        /* File Input */
        .file-input {
            display: block;
            width: 80%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background-color: #f8f8f8;
            margin-bottom: 10px;
            cursor: pointer;
        }

        /* File Input Hover/Focus Styles */
        .file-input:hover, .file-input:focus {
            border-color: #0056b3;
            background-color: #e7f3ff;
        }

        /* File Message (Error or Success) */
        .file-message {
            color: #d9534f;
            font-size: 12px;
        }
        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }
        .signature-box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            align-items: center;
            background: #DCDCDC;
            width:300px;
            height:205px;
        }
        #signature-pad-1 {
            background: #fff;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        /* Buttons */
        .form-group .buttons{
            font-family: 'Montserrat', arial, serif;
            font-size: large;
            cursor: pointer;
        }
        .buttons #cancel {
            background-color: #A9A9A9;
            color: #fff;
        }
        .buttons #accept {
            background-color: #3471d6;
            color: #fff;
            margin-left: 50px;
        }
        /* Align radio buttons horizontally */
        .form-group input[type="radio"] {
            margin-right: 10px;
            display: inline-block;
        }

        .form-group label {
            margin-right: 20px;
            display: inline-block;
        }

        /* Align checkbox horizontally */
        .form-group input[type="checkbox"] {
            margin-right: 10px;
            display: inline-block;
        }

        /* Optional: add some space between the checkbox and label */
        .form-group input[type="checkbox"] + label {
            display: inline-block;
            margin-top: 5px;
        }
        .form-group a {
            text-decoration: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: none;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .flash-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        .flash-message.success { background-color: #4CAF50; }
        .flash-message.error { background-color: #f44336; }
        .flash-message.info { background-color: #2196F3; }
    </style>
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->
</head>
<body>
    <div class="overlay">
        <div class="floating-window">
            <div class="window-header">
                <h2>Annuity Verification Certificate</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="window-content">
                <div class="sidebar">
                    <h3>Progress</h3>
                    <ul>
                        <li><a href="#" class="step-link active" data-step="1">Step 1: Personal Info</a></li>
                        <li><a href="#" class="step-link" data-step="2">Step 2: Identity Verification</a></li>
                        <li><a href="#" class="step-link" data-step="3">Step 3: Document Upload</a></li>
                        <li><a href="#" class="step-link inactive" data-step="4">Step 4: Submission</a></li>
                    </ul>
                </div>
                <div class="main-content">
                    <form id="multiStepForm" method="POST">
                        <div class="form-step active" id="step1">
                            <h3>Step 1: Personal Information</h3>
                            <p>Enter your personal details here.</p>
                            <div class="form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullName" name="fullName" required>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label for="idNumber">ID Number</label>
                                    <input type="number" id="idNumber" name="idNumber" required>
                                </div>
                                <div class="form-group">
                                    <label for="phoneNumber">Phone Number</label>
                                    <input type="tel" id="phoneNumber" name="phoneNumber" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="kraPin">KRA Pin</label>
                                <input type="text" id="kraPin" name="kraPin" required>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label for="address">Address</label>
                                    <input type="text" id="address" name="address" required>
                                </div>
                                <div class="form-group">
                                    <label for="code">Code</label>
                                    <input type="text" id="code" name="code" required>
                                </div>
                                <div class="form-group">
                                    <label for="town">Town</label>
                                    <input type="text" id="town" name="town" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="emailAddress">Email Address</label>
                                <input type="email" id="emailAddress" name="emailAddress" required>
                            </div>
                            <button type="button" class="skip-btn" data-skip="2">Skip</button>
                        </div>
                        <div class="form-step" id="step2">
                            <h3>Step 2: Identity Verification</h3>
                            <p>Please ensure the photo is clear and your face is fully visible.</p>

                            <!-- Webcam video wrap -->
                            <div class="video-wrap">
                                <video id="video" autoplay></video>
                                <canvas id="canvas"></canvas>
                            </div>

                            <div class="canvas-btn">
                                <!-- Capture and confirm buttons -->
                                <button id="capture-btn">Capture Photo</button>
                                <button id="confirm-btn" disabled>Confirm Photo</button>
                                <button id="redo-btn" disabled>Redo</button>
                            </div>
                            <div id="feedback"></div>
                            <input type="hidden" id="photoData" name="photoData" value="false"> 
                            <button type="button" class="skip-btn" data-skip="3">Skip</button>
                        </div>
                        <div class="form-step" id="step3">
                            <h3>Step 3: Document Upload</h3>
                            <p>Upload the following documents: ID Card (Both sides), KRA Pin Certificate, ATM Card</p>
                            <div class="upload-container">
                                <div class="upload-files">
                                    <!-- ID Card Upload (Front) -->
                                    <div class="file-upload-group">
                                        <label for="id-card-front" class="upload-label">ID Card Front</label>
                                        <input type="file" accept="image/*,.pdf" id="id-card-front" name="id-card-front"   class="file-input"  onchange="FileUploadModule.handleFileUpload(event)">
                                        <p id="id-card-front-message" class="file-message"></p>
                                    </div>
                                    <!-- ID Card Upload (Back) -->
                                    <div class="file-upload-group">
                                        <label for="id-card-back" class="upload-label">ID Card Back</label>
                                        <input type="file" accept="image/*,.pdf" id="id-card-back" name="id-card-back"  class="file-input"  onchange="FileUploadModule.handleFileUpload(event)">
                                        <p id="id-card-back-message"   class="file-message"></p>
                                    </div>
                                    <!-- KRA Pin Certificate Upload -->
                                    <div class="file-upload-group">
                                        <label for="kra-pin-certificate" class="upload-label">KRA Pin Certificate</label>
                                        <input type="file" accept="image/*,.pdf" id="kra-pin-certificate" name="kra-pin-certificate"  class="file-input"  onchange="FileUploadModule.handleFileUpload(event)">
                                        <p id="kra-pin-certificate-message" class="file-message"></p>
                                    </div>
                                    <!-- ATM Card Upload -->
                                    <div class="file-upload-group">
                                        <label for="atm-card" class="upload-label">ATM Card</label>
                                        <input type="file" accept="image/*,.pdf" id="atm-card" name="atm-card" class="file-input"  onchange="FileUploadModule.handleFileUpload(event)">
                                        <p id="atm-card-message" class="file-message"></p>
                                    </div>

                                </div>
                            </div>
                            <button type="button" class="skip-btn" data-skip="4">Skip</button>
                        </div>
                        <div class="form-step" id="step4">
                            <h3>Step 4: Submission</h3>
                            <p>Please sign and accept the data protection clause to submit successfully.</p>
                            <div class="signature-box">
                                <label for="signature-pad-1">Sign Here:</label>
                                <canvas id="signature-pad-1" width="250" height="150"></canvas>
                                <div class="buttons">
                                    <button type="button" class="btn btn-danger btn-sm" id="cancel">Cancel</button>
                                    <button type="button" class="btn btn-primary btn-sm" id="accept">Accept</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Do you want Personal Relief?</label>
                                <input type="radio" name="personalRelief" id="personal-relief-yes" value="yes" >
                                <label for="personal-relief-yes">Yes</label>
                                <input type="radio" name="personalRelief" id="personal-relief-no" value="no" >
                                <label for="personal-relief-no">No</label>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="dataProtectionCheckbox" name="dataProtectionCheckbox" required disabled>
                                <label for="dataProtectionCheckbox">
                                    I agree that I have read and understood the 
                                    <a href="#" id="dataProtectionLink">Data Protection Notice</a>.
                                </label>
                            </div>
                            
                            <input type="hidden" id="dataProtectionAccepted" name="dataProtectionAccepted" value="false">                            
                        </div>
                        <div class="button-container">
                            <button type="button" id="prevBtn" class="nav-button" disabled>Previous</button>
                            <button type="button" id="nextBtn" class="nav-button">Next</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="dataProtectionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Data Protection Notice</h2>
            <div class="modal-body">                
                <!-- Data Protection Agreement Content -->
                <p><strong>Introduction</strong><br>Your privacy and data protection are important to us. Please read the terms below carefully to understand how we collect, use, and protect your information. By accepting these terms, you consent to our data handling practices as outlined here.</p>

                <p><strong>1. Data Collection and Use</strong><br>We collect personal data to provide you with better service and to fulfill our obligations. This may include personal identification, contact information, and any data directly related to the services you receive from us.</p>

                <p><strong>2. Purpose of Data Processing</strong><br>Your personal data is processed to:
                    <ul>
                        <li>Facilitate our services and improve user experience.</li>
                        <li>Comply with legal obligations.</li>
                        <li>Communicate important updates and provide relevant information.</li>
                    </ul>
                </p>

                <p><strong>3. Data Sharing and Third Parties</strong><br>We may share your data with trusted third parties under strict data protection policies, ensuring that your information remains secure and confidential. These third parties are bound by data protection obligations equivalent to ours.</p>

                <p><strong>4. Data Security</strong><br>We implement technical and organizational measures to protect your data against unauthorized access, loss, or destruction. Only authorized personnel have access to your data, and they are required to handle it confidentially.</p>

                <p><strong>5. Your Rights</strong><br>You have the right to:
                    <ul>
                        <li>Access your data at any time.</li>
                        <li>Request corrections if any information is inaccurate.</li>
                        <li>Request the deletion of your data under certain circumstances.</li>
                        <li>Withdraw consent for specific uses at any time.</li>
                    </ul>
                </p>

                <p><strong>6. Retention Period</strong><br>Your data will only be kept for as long as necessary to fulfill the purposes outlined or as required by law.</p>

                <p><strong>7. Acceptance</strong><br>By selecting “Accept,” you acknowledge that you have read, understood, and agreed to the terms of our data protection agreement.</p>
            </div>
            <div class="modal-footer">
                <button id="completeButton" class="btn btn-primary">Accept</button>
                <button id="rejectButton" class="btn btn-secondary">Reject</button>
            </div>
        </div>
    </div>


    <div id="flashMessage" class="flash-message"></div>

</body>   

    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        // Global variables and constants

        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_FILE_TYPES = ['application/pdf', 'image/jpeg', 'image/jpg'];

        let currentStep = 1;
        const totalSteps = 4;
        let signaturePad;

        // DOM Elements
        const form = document.getElementById('multiStepForm');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapButton = document.getElementById('snap');
        const redoButton = document.getElementById('redo');
        const confirmButton = document.getElementById('confirm');
        const controller = document.querySelector('.controller');
        const fileInput = document.getElementById('input-file');
        const fileList = document.getElementById('uploaded-files-list');
        const flashMessageElement = document.getElementById('flashMessage');

        // Utility functions
        const showFlashMessage = (message, type = 'info') => {
            flashMessageElement.textContent = message;
            flashMessageElement.className = `flash-message ${type}`;
            flashMessageElement.style.display = 'block';
            setTimeout(() => {
                flashMessageElement.style.display = 'none';
            }, 3000);
        };

        // Form Navigation Module
        const FormNavigation = {
            updateButtons() {
                prevBtn.disabled = (currentStep === 1);
                nextBtn.textContent = (currentStep === totalSteps) ? 'Submit' : 'Next';
            },

            showStep(step) {
                document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
                document.getElementById(`step${step}`).classList.add('active');
                currentStep = step;
                this.updateButtons();

                if (step === 2) {
                    WebcamModule.startWebcam();
                } else if (step === 4 && !signaturePad) {
                    SignatureModule.initSignaturePad();
                }
            },

            skipToStep(step) {
                if (step >= 1 && step <= totalSteps) {  // Ensure step is within valid range
                    this.showStep(step);
                } else {
                    console.warn(`Step ${step} is out of range. Please enter a step between 1 and ${totalSteps}.`);
                }
            }
        };

        // Validation Module
        const Validation = {
            rules: {
                fullName: (value) => value.trim().length > 0,
                idNumber: (value) => /^\d{8}$/.test(value),
                phoneNumber: (value) => /^\d{10}$/.test(value),
                kraPin: (value) => /^[A-Z]\d{9}[A-Z]$/.test(value),
                emailAddress: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
            },

            validateStep(step) {
                const stepElement = document.getElementById(`step${step}`);
                const inputs = stepElement.querySelectorAll('input[required]');
                let isValid = true;

                inputs.forEach(input => {
                    const rule = this.rules[input.id] || (() => true);
                    if (!rule(input.value)) {
                        isValid = false;
                        this.showError(input, `Invalid ${input.name}`);  // Optional: Customize this message
                    } else {
                        this.clearError(input);
                    }
                });

                // Step-specific validations
                if (step === 2) {
                    isValid = isValid && WebcamModule.validateSelfie();
                } else if (step === 3) {
                    isValid = isValid && FileUploadModule.validateFileUploads();
                } else if (step === 4) {
                    isValid = isValid && SignatureModule.validateSignature();
                }

                if (!isValid) {
                    showFlashMessage('Please correct the errors before proceeding.', 'error');
                }

                return isValid;
            },

            showError(input, message) {
                let errorElement = input.nextElementSibling;
                
                // Create the error message element if it doesn't exist
                if (!errorElement || !errorElement.classList.contains('error-message')) {
                    errorElement = document.createElement('div');
                    errorElement.classList.add('error-message');
                    input.parentNode.insertBefore(errorElement, input.nextSibling);
                }
                
                // Add the error message and exclamation mark
                errorElement.textContent = `❌ ${message}`;
                
                // Add red outline to the invalid input field
                input.classList.add('error');
            },

            clearError(input) {
                const errorElement = input.nextElementSibling;
                
                // Remove error message if it exists
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.remove();
                }
                
                // Remove red outline from the input field
                input.classList.remove('error');
            }
        };

        // Styling for the validation feedback
        const styles = `
            .error {
                border: 2px solid red;  /* Red border for invalid fields */
                background-color: #ffefef; /* Light red background to highlight the error */
            }

            .error-message {
                color: red;
                font-size: 12px;
                margin-top: 5px;
                display: inline-block;
            }

            .error-message::before {
                content: "❌";  /* Exclamation mark or icon */
                margin-right: 5px;
            }
        `;

        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = styles;
        document.head.appendChild(styleSheet);
        
        // File Upload Module
        const FileUploadModule = {
            handleFileUpload(event) {
                const fileInput = event.target;
                const files = fileInput.files;
                const messageElement = document.getElementById(`${fileInput.id}-message`);
                messageElement.innerHTML = '';  // Clear previous message
                messageElement.classList.remove('success', 'error'); // Clear previous styling

                // Loop through each selected file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (this.isValidFile(file)) {
                        messageElement.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB) - Uploaded successfully.`;
                        messageElement.classList.add('success'); // Apply success styling
                        
                        // Optionally add the file to a storage object
                        this.addFile(file, fileInput.id);
                    } else {
                        messageElement.textContent = `File ${file.name} is not allowed. Please upload only PDF or JPG files under 5MB.`;
                        messageElement.classList.add('error'); // Apply error styling
                    }
                }
            },

            isValidFile(file) {
                const ALLOWED_FILE_TYPES = ['application/pdf', 'image/jpeg', 'image/png'];
                const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

                return ALLOWED_FILE_TYPES.includes(file.type) && file.size <= MAX_FILE_SIZE;
            },

            addFile(file, fileType) {
                if (!this.files) {
                    this.files = {}; // Initialize files object if not already done
                }

                // Save each file based on the specific input type
                switch (fileType) {
                    case 'id-card-front':
                        this.files['idCardFront'] = file;
                        break;
                    case 'id-card-back':
                        this.files['idCardBack'] = file;
                        break;
                    case 'kra-pin-certificate':
                        this.files['kraPinCertificate'] = file;
                        break;
                    case 'atm-card':
                        this.files['atmCard'] = file;
                        break;
                    default:
                        console.warn(`Unhandled file type: ${fileType}`);
                }
            },

            validateFileUploads() {
                const requiredFiles = ['idCardFront', 'idCardBack', 'kraPinCertificate', 'atmCard'];
                
                for (let fileKey of requiredFiles) {
                    if (!this.files || !this.files[fileKey]) {
                        showFlashMessage(`Please upload the ${this.getFileLabel(fileKey)}.`, 'error');
                        return false;
                    }
                }
                return true;
            },

            getFileLabel(fileKey) {
                switch (fileKey) {
                    case 'idCardFront':
                        return 'ID Card Front';
                    case 'idCardBack':
                        return 'ID Card Back';
                    case 'kraPinCertificate':
                        return 'KRA Pin Certificate';
                    case 'atmCard':
                        return 'ATM Card';
                    default:
                        return 'Unknown file';
                }
            }
        };
        // Webcam Module
        const WebcamModule = {
            videoElement: document.getElementById('video'),
            canvasElement: document.getElementById('canvas'),
            captureBtn: document.getElementById('capture-btn'),
            confirmBtn: document.getElementById('confirm-btn'),
            redoBtn: document.getElementById('redo-btn'),
            feedback: document.getElementById('feedback'),

            // Start webcam stream
            startWebcam() {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        this.videoElement.srcObject = stream;
                    })
                    .catch(error => {
                        console.error("Error accessing webcam: ", error);
                        this.feedback.textContent = "Could not access webcam.";
                    });
            },

            // Capture photo and display it on canvas
            capturePhoto() {
                const context = this.canvasElement.getContext('2d');
                this.canvasElement.width = 640;  // Resize width
                this.canvasElement.height = 480; // Resize height
                context.drawImage(this.videoElement, 0, 0, this.canvasElement.width, this.canvasElement.height);
                this.captureBtn.disabled = true;  // Disable capture button
                this.confirmBtn.disabled = false; // Enable confirm button
                this.redoBtn.disabled = false;    // Enable redo button
                this.feedback.textContent = "Photo captured. Please confirm or redo.";
            },

            // Confirm the photo and send it as a POST request
            confirmPhoto() {
                const dataURL = this.canvasElement.toDataURL('image/png', 0.7); // Convert canvas to data URL with compression
                console.log("Generated data URL:", dataURL);  // Log the generated base64 data URL
                this.feedback.textContent = "Photo confirmed! Ready to proceed with the rest of the form.";

                // Save the captured photo temporarily (using localStorage or a variable)
                localStorage.setItem('savedPhoto', dataURL);  // Store in localStorage
                // Or you can store it in a JavaScript object or variable if you prefer to keep it in memory
                // this.savedPhoto = dataURL;

                // Set the data URL as the value of the hidden input field (to keep it for later)
                const photoDataInput = document.getElementById('photoData');
                if (photoDataInput) {
                    photoDataInput.value = dataURL;
                }

                // Disable the confirm button or show a success message
                document.getElementById('confirm-btn').disabled = true;
            },

            // Redo the photo
            redoPhoto() {
                const context = this.canvasElement.getContext('2d');
                context.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                this.captureBtn.disabled = false;  // Enable capture button
                this.confirmBtn.disabled = true;   // Disable confirm button
                this.redoBtn.disabled = true;      // Disable redo button
                this.feedback.textContent = "Please capture a new photo.";
            },

            // Validate the selfie (used in the Validation module)
            validateSelfie() {
                const context = this.canvasElement.getContext('2d');
                const imageData = context.getImageData(0, 0, this.canvasElement.width, this.canvasElement.height);
                if (imageData.data.some(value => value !== 0)) {
                    return true; // Selfie is valid
                } else {
                    this.feedback.textContent = "Please capture a valid photo.";
                    return false; // Selfie is invalid
                }
            }
        };

        // Initialize webcam and set up event listeners
        window.addEventListener('DOMContentLoaded', () => {
            WebcamModule.startWebcam();

            WebcamModule.captureBtn.addEventListener('click', () => WebcamModule.capturePhoto());
            WebcamModule.confirmBtn.addEventListener('click', () => WebcamModule.confirmPhoto());
            WebcamModule.redoBtn.addEventListener('click', () => WebcamModule.redoPhoto());
        });

        // Signature Module
        const SignatureModule = {
            initSignaturePad() {
                const canvas = document.getElementById('signature-pad-1');
                signaturePad = new SignaturePad(canvas);

                document.getElementById('cancel').addEventListener('click', () => {
                    signaturePad.clear();
                });

                document.getElementById('accept').addEventListener('click', () => {
                    if (signaturePad.isEmpty()) {
                        showFlashMessage('Please provide a signature first.', 'error');
                    } else {
                        showFlashMessage('Signature accepted.', 'success');
                        // Here you could save the signature data
                        // const signatureData = signaturePad.toDataURL();
                    }
                });
            },

            validateSignature() {
                if (!signaturePad || signaturePad.isEmpty()) {
                    showFlashMessage('Please provide a signature.', 'error');
                    return false;
                }
                return true;
            }
        };

        // Data Protection Modal Module
        const DataProtectionModal = (function () {
            // Private variables
            let modal = null;
            let acceptButton = null;
            let rejectButton = null;
            let closeButton = null;
            
            // Configuration
            const config = {
                modalId: "dataProtectionModal",
                acceptButtonId: "completeButton",
                rejectButtonId: "rejectButton",
                closeButtonClass: "close",
                triggerLinkId: "dataProtectionLink",
                checkboxId: "dataProtectionCheckbox",
                hiddenInputId: "dataProtectionAccepted"
            };
            
            function init() {
                // Get DOM elements
                modal = document.getElementById(config.modalId);
                
                // Check if modal exists
                if (!modal) {
                    console.error("Data Protection Modal: Modal element not found");
                    return false;
                }
                
                // Get buttons and required elements
                acceptButton = document.getElementById(config.acceptButtonId);
                rejectButton = document.getElementById(config.rejectButtonId);
                closeButton = modal.querySelector(`.${config.closeButtonClass}`);
                
                // Validate required elements
                if (!acceptButton || !rejectButton) {
                    console.error("Data Protection Modal: Required buttons not found");
                    return false;
                }
                
                // Add event listeners
                addEventListeners();
                return true;
            }
            
            function addEventListeners() {
                const triggerLink = document.getElementById(config.triggerLinkId);
                
                if (triggerLink) {
                    triggerLink.addEventListener("click", (event) => {
                        event.preventDefault();
                        open();
                    });
                }
                
                if (closeButton) {
                    closeButton.addEventListener("click", close);
                }
                
                window.addEventListener("click", (event) => {
                    if (event.target === modal) {
                        close();
                    }
                });
                
                acceptButton.addEventListener("click", () => {
                    handleAccept();
                });
                
                rejectButton.addEventListener("click", () => {
                    handleReject();
                });
            }
            
            function open() {
                if (!modal) {
                    console.error("Data Protection Modal: Cannot open - modal not initialized");
                    return;
                }
                modal.style.display = "block";
                modal.classList.add("active");
            }
            
            function close() {
                if (!modal) return;
                
                modal.style.display = "none";
                modal.classList.remove("active");
            }
            
            function handleAccept() {
                localStorage.setItem("dataProtectionAccepted", "true");
                updateFormState(true);
                showFlashMessage("You have accepted the data protection terms.", "success");
                close();
            }
            
            function handleReject() {
                localStorage.setItem("dataProtectionAccepted", "false");
                updateFormState(false);
                showFlashMessage("You have rejected the data protection terms. You cannot proceed further.", "warning");
                close();
            }
            
            function updateFormState(isAccepted) {
                const checkbox = document.getElementById(config.checkboxId);
                const hiddenInput = document.getElementById(config.hiddenInputId);
                
                if (checkbox) {
                    checkbox.checked = isAccepted;
                    checkbox.disabled = true;
                }
                
                if (hiddenInput) {
                    hiddenInput.value = isAccepted.toString();
                }
                
                const submitButton = document.querySelector("button[type='submit']");
                if (submitButton) {
                    submitButton.disabled = !isAccepted;
                }
            }
            
            // Public API
            return {
                init,
                open,
                close,
                isAccepted: () => localStorage.getItem("dataProtectionAccepted") === "true"
            };
        })();

        // Initialize the modal
        document.addEventListener("DOMContentLoaded", () => {
            DataProtectionModal.init();
        });



        // CSRF Protection
        const CSRFProtection = {
            token: null,

            init() {
                this.token = this.generateToken();
                this.addTokenToForm();
            },

            generateToken() {
                return Math.random().toString(36).substr(2) + Math.random().toString(36).substr(2);
            },

            addTokenToForm() {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = this.token;
                form.appendChild(tokenInput);
            },

            validateToken(token) {
                return token === this.token;
            }
        };

        // Submit Data to Server
        function submitForm(photoData = null) {
            const form = document.getElementById('multiStepForm');
            if (!form) {
                console.error("Form element not found. Ensure the form has id='multiStepForm'.");
                showFlashMessage('An error occurred. Form element not found.', 'error');
                return;
            }

            if (Validation.validateStep(totalSteps)) {
                try {
                    const formData = new FormData(form);
                    formData.append('signature', signaturePad.toDataURL()); // Add the signature

                    // Check if the photo is stored in localStorage or passed as an argument
                    const storedPhoto = localStorage.getItem('savedPhoto');
                    if (storedPhoto || photoData) {
                        // Use the stored photo or the passed photoData
                        formData.append('photo', storedPhoto || photoData); // Append the photo to the form data
                    }

                    // Append file inputs to the form data
                    const fileInputs = form.querySelectorAll('input[type="file"]');
                    fileInputs.forEach(input => {
                        for (let i = 0; i < input.files.length; i++) {
                            formData.append(input.id, input.files[i]);
                        }
                    });

                    console.log('Form submitted with the following data:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }

                    // Send the form data to the backend via POST
                    fetch('/submit-form', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showFlashMessage('Form submitted successfully!', 'success');
                            window.location.href = '/thank-you'; // Redirect after submission
                        } else {
                            showFlashMessage('An error occurred. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting form:', error);
                        showFlashMessage('An error occurred while submitting the form. Please try again.', 'error');
                    });
                } catch (error) {
                    console.error('Error in submitForm function:', error);
                    showFlashMessage('An error occurred while submitting the form. Please try again.', 'error');
                }
            }
        }

        // Event listeners
        nextBtn.addEventListener('click', () => {
            if (currentStep < totalSteps) {
                if (Validation.validateStep(currentStep)) {
                    FormNavigation.showStep(currentStep + 1);
                }
            } else {
                submitForm();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                FormNavigation.showStep(currentStep - 1);
            }
        });

        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const step = parseInt(link.getAttribute('data-step'));
                if (step < currentStep || Validation.validateStep(currentStep)) {
                    FormNavigation.showStep(step);
                }
            });
        });

        // Add click event listeners to all skip buttons
        document.querySelectorAll('.skip-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const skipToStep = parseInt(e.target.dataset.skip);
                FormNavigation.skipToStep(skipToStep);
            });
        });

        document.querySelector('.close-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to close the form? All progress will be lost.')) {
                document.querySelector('.overlay').style.display = 'none';
                WebcamModule.stopWebcam();
            }
        });

        // fileInput.addEventListener('change', (event) => FileUploadModule.handleFileUpload(event));

        // Initialize the form
        FormNavigation.updateButtons();
        CSRFProtection.init();
    </script>
</body>
</html>