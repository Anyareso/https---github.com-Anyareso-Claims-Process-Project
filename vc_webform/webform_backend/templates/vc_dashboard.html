<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Add Bootstrap Icons for logout icon -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .table-responsive {
            max-height: 70vh;
            overflow-y: auto;
        }
        .img-thumbnail {
            max-width: 100px;
            height: auto;
        }
        .search-bar {
            max-width: 300px;
            margin-bottom: 20px;
        }
        .table-responsive {
            margin-top: 20px; /* Adds space between filters and the table */
        }
        .alert {
            transition: opacity 0.3s ease-out;
        }

        .alert.fade {
            opacity: 0;
        }

        .alert.show {
            opacity: 1;
        }
        .logout-btn {
            margin-bottom: 20px;
        }
    </style>
    <script>
        // Function to filter submissions by search input
        function searchTable() {
            let input = document.getElementById('searchInput').value.toLowerCase();
            let table = document.getElementById('submissionsTable');
            let rows = table.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) {
                let cells = rows[i].getElementsByTagName('td');
                let match = false;
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().indexOf(input) > -1) {
                        match = true;
                        break;
                    }
                }
                rows[i].style.display = match ? '' : 'none';
            }
        }

        // Function to filter by date range
        function filterByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Ensure both start and end dates are selected
            if (!startDate || !endDate) {
                // Trigger the flash message for missing dates
                flashMessage('Please select both start and end dates.', 'danger');
                return;
            }

            // Convert to Date objects for comparison
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);

            // Ensure start date is not later than end date
            if (startDateObj > endDateObj) {
                // Trigger the flash message for invalid date range
                flashMessage('Start date cannot be later than the end date.', 'danger');
                return;
            }

            const rows = document.querySelectorAll('#submissionsTable tbody tr');
            rows.forEach(row => {
                const dateCell = row.cells[7]; // Assuming the date is in the 8th column (index 7)
                const submissionDate = new Date(dateCell.textContent);

                // Display or hide rows based on date range
                if (submissionDate >= startDateObj && submissionDate <= endDateObj) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Helper function to trigger flash messages in the backend
        function flashMessage(message, category) {
            // Send the flash message to the backend through a request
            fetch('/trigger_flash_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,   // Dynamic message
                    category: category  // Dynamic category (e.g., "danger", "success")
                })
            })
            .then(response => response.json())
            .then(data => {
                location.reload();  // Reloads the page to show the flash message
            })
            .catch(error => {
                console.error('Error sending flash message:', error);
            });
        }


        // Function to export full submission details to CSV
        function exportToCSV() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Construct the URL with the date range parameters
            const url = `/export_csv?start_date=${startDate}&end_date=${endDate}`;

            // Redirect to the backend endpoint to trigger the download
            window.location.href = url;
        }
        // Automatically hide flash messages after 5 seconds
        window.addEventListener('DOMContentLoaded', (event) => {
            const flashMessages = document.querySelectorAll('.alert');
            flashMessages.forEach((flashMessage) => {
                setTimeout(() => {
                    flashMessage.classList.remove('show');
                    flashMessage.classList.add('fade');
                }, 3000);  // 5000 milliseconds (3 seconds)
            });
        });
    </script>
</head>

<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} fade show" role="alert" id="flash-message">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="container my-5">
        <!-- Logout Button -->
        <a href="{{ url_for('logout') }}" class="btn btn-danger logout-btn">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>

        <h2 class="mb-4">Submissions Dashboard</h2>

        <!-- Search Input -->
        <input type="text" id="searchInput" class="form-control search-bar" onkeyup="searchTable()" placeholder="Search for submissions...">

        <!-- Date Filter Inputs -->
        <div class="row mt-3">
            <div class="col-md-4">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-4 align-self-end">
                <button onclick="filterByDate()" class="btn btn-primary mt-2">Filter by Date</button>
                <button onclick="exportToCSV()" class="btn btn-success mt-2">Generate Report</button>
            </div>
        </div>

        <!-- Submissions Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="submissionsTable">
                <thead class="thead-dark">
                    <tr>
                        <th>Policy No.</th>
                        <th>Name</th>
                        <th>ID Number</th>
                        <th>Email</th>
                        <th>Documents</th>
                        <th>Captured Image</th>
                        <th>Signature</th>
                        <th>Date submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Actual backend-generated rows -->
                    <tr>
                        {% for submission in submissions %}
                        <td>{{ submission.policy_no or 'N/A' }}</td>
                        <td>{{ submission.full_name }}</td>
                        <td>{{ submission.id_number }}</td>
                        <td>{{ submission.email_address }}</td>
                        <td><a href="{{ submission.id_card_front }}" download>Download Document</a></td>
                        <td>
                            <img src="{{ url_for('uploaded_file', filename=submission.photo_data) }}" alt="Captured Image" class="img-thumbnail">
                        </td>
                        <td>
                            <img src="{{ url_for('uploaded_file', filename=submission.signature_data) }}" alt="Signature" class="img-thumbnail">
                        </td>                                              
                        <td>{{ submission.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <!-- View Button links to individual submission page -->
                            <a href="{{ url_for('submission_details', submission_id=submission.id) }}" target="_blank"  class="btn btn-primary btn-sm">View</a>
                            <!-- Delete Button -->
                            <form action="{{ url_for('delete_submission', submission_id=submission.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this submission?');">
                                <button type="submit" class="btn btn-danger btn-sm" style="margin-top: 15px;">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>
